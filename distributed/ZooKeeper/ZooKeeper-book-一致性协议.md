# ZooKeeper book 一致性协议

---

## Document & Code
> * [../Zookeeper-book](https://github.com/zozospider/note/blob/master/distributed/ZooKeeper/ZooKeeper-book.md)

---

## 从集中式到分布式

### 集中式的特点
> * 所有业务单元集中部署在一个中心节点。

### 分布式的特点
> 1. 分布性
> * 多台计算机随意分布，随时变动。

> 2. 对等性
> * 没有主/从之分，所有计算机节点都是对等的，`数据副本`（在不同节点上持久化同一份数据）和`服务副本`（多个节点提供同样的服务）。

> 3. 并发性
> * 多个节点并发的操作一些共享资源。

> 4. 缺乏全局始终
> * 缺乏一个全局的时钟控制。

> 5. 故障总是会发生
> * 任何在设计阶段考虑到的异常情况，一定会在系统实际运行中发生。

### 分布式环境的各种问题
> 1. 通信异常
> * 节点间通信不稳定。

> 2. 网络分区
> * 部分节点之间可以正常通信，出现局部小集群（脑裂）。

> 3. 三态
> * 每次请求与响应状态，分为，成功、失败、超时。
> * 网络是不可靠的，可能发送过程失败，可能响应过程失败，无法确定当前请求是否被成功处理。

> 4. 节点故障
> * 每个节点都可能出现故障。

## 从ACID到CAP/BASE

### ACID
> 事物的特性：原子性（Atomicity）、一致性（Consistency）、隔离性（Isolation）、持久性（Durability）。

> 1. 原子性（Atomicity）
> * 事务操作，要么全部执行，要么全部不执行。

> 2. 一致性（Consistency）
> * 事务执行的结果使得数据库从一个状态变为另一个状态。

> 3. 隔离性（Isolation）
> * 并发事务是相互隔离的，操作相同数据时，每个事务都有各自的数据空间，互不干扰。

> * 以下为事务的隔离级别:
>> 3.1 未提交读取（可以读取其他事务未提交的数据。存在脏读，不可以重复读，存在幻读）
>> 3.2 已提交读取（不可以读取其他事务未提交的数据。不存在脏读，不可以重复读，存在幻读）
> * 3.3 可重复读取（保证多次读取同一个数据，得到结果都是和最开始读取的时候是一样的。不存在脏读，可以重复读，存在幻读）
> * 3.4 串行化（所有事务不可并发执行。不存在脏读，可以重复读，不存在幻读）

> 4. 持久性（Durability）
> * 事务一旦提交，就是永久性的，及时宕机。


### CAP
> 一个分布式系统不可能同时满足：一致性（Consistency）、可用性（Availability）、分区容错性（Partition tolerance），最多只能同时满足两项。

> 1. 一致性（Consistency）
> * 在分布式系统中，如果可以做到针对一个数据的更新操作执行成功后，所有的用户都可以读取到最新的值，那么认为其具有强一致性（严格一致性）。

> 2. 可用性（Availability）
> * 对于用户的每一个操作总是能够在有限的时间内返回结果（7*24小时）。

> 3. 分区容错性（Partition tolerance）
> * 分布式系统在遇到任何网路分区（节点/子网络）故障的时候，任然可保证对外满足一致性和可用性服务。

### BASE
> * BASE：基本可用（Basically Available）、软状态（Soft state）、最终一致性（Eventually consistent）。
> * BASE是对CAP中一致性和可用性权衡的结果。核心思想是，即使无法做到强一致性（Strong consistency），但是每个应用都可以根据自身业务特点，采用适当的方式使系统达到最终一致性（Eventual consistency）。

> 1. 基本可用（Basically Available）
> * 允许损失部分可用性，如：发生故障时，响应时间变长。请求过多时，部分响应引导到降级页面。

> 2. 软状态（Soft state）
> * 允许系统在不同节点的数据副本之间进行数据同步时存在延时。

> 3. 最终一致性（Eventually consistent）
> * 所有数据副本，最终能够达到一个一致的状态。

> * 最终一致性存在五类变种:
> 3.1 因果一致性（如果进程A更新后通知进程B，那么B一定获取到的是A更新后的最新值）
> 3.2 读已之所写（进程A更新后，它自己总是能访问到更新后的最新值）
> 3.3 会话一致性（一个会话中，实现读已之所写。也就是执行更新后，客户端能够在同一个会话中始终能读取到最新值）
> 3.4 单调读一致性（如果一个进程读取一个数据的某个值后，那么该进程后续读取该数据都不应该返回更旧的值）
> 3.5 单调写一致性（需要保证同一个进程的写操作被顺序执行）


