# Document & Code

* [../Zookeeper-book](https://github.com/zozospider/note/blob/master/distributed/ZooKeeper/ZooKeeper-book.md)

---

# 一. 2PC 与 3PC

一致性协议与算法，2PC, 3PC, Paxos算法。

## 2PC

二阶段提交（Two-Phase-Commit），将事务分为两个阶段来处理：投票和执行。

核心是：每个事务先尝试后提交。（强一致性算法）

### 阶段一. 提交事务请求

提交事务请求分为如下 3 个步骤：
* a. 事务询问（向节点询问是否可以执行事务）
* b. 执行事务（各个节点执行事务，记录 Undo、Redo）
* c. 向协调者反馈响应（反馈 Yes / No）

### 阶段二. 执行事务提交

此阶段协调者根据阶段一的反馈，决定是否提交事务。包括两种情况：

中断事务：
* a. 发送回滚请求（阶段一任何节点发送了 No，则协调者向所有节点发送 Rollback） 
* b. 事务回滚（节点收到 Rollback，利用阶段一记录的 Undo 执行回滚）
* c. 反馈回滚结果（反馈 Ack）
* d. 中断事务（协调者收到所有 Ack 后中断事务）

执行事务：
* a. 发送事务提交（阶段一所有节点发送了 Yes，则协调者向所有节点发送 Commit）
* b. 事务提交（节点收到 Commit，执行提交）
* c. 反馈提交结果（反馈 Ack）
* d. 完成事务（协调周收到所有 Ack 后完成事务）

### 优缺点

优点：原理简单，实现方便。

缺点：
* a. 同步阻塞（各个节点必须阻塞等待其他节点）
* b. 单点问题（协调者单点）
* c. 数据不一致（如果网络问题，阶段二部分节点收到 Commit 请求后执行提交，另一部分节点没有收到 Commit 请求，出现数据不一致现象）
* d. 太过保守（任何一个节点失败，导致整体失败）

## 3PC

三阶段提交（Three-Phase-Commit），将事务分为三个阶段来处理：CanCommit, PreCommit, DoCommit。

### 阶段一. CanCommit

CanCommit分为如下 2 个步骤：
* a. 事务询问（向节点询问是否可执行事务提交）
* b. 反馈询问结果（如果认为可以执行，则反馈 Yes，进入 Prepare 状态，否则反馈 No）

### 阶段二. PreCommit

此阶段协调者根据阶段一的反馈，决定是否 PreCommit。包括两种情况：

中断事务：
* a. 发送中断请求（阶段一任何节点反馈了 No，则协调者向所有节点发送 abort）
* b. 中断事务（节点收到 abort，或者协调者超时，都会中断事务）

执行预提交：
* a. 发送事务预提交（阶段一所有节点发送了 Yes，则协调者向所有节点发送 PreCommit）
* b. 事务预提交（节点收到 PreCommit，执行事务，记录 Undo、Redo）
* c. 反馈预提交结果（反馈 Ack）

### 阶段三. DoCommit

此阶段协调者根据阶段二的反馈，决定是否 DoCommit。包括两种情况：

中断事务：
* a. 发送中断请求（阶段一任何节点反馈了 No，则协调者向所有节点发送 abort）
* b. 中断事务（节点收到 abort，利用阶段一记录的 Undo 执行回滚）
* c. 反馈回滚结果（反馈 Ack）
* d. 中断事务（协调者收到所有 Ack 后中断事务）

执行提交：
* a. 发送事务提交（阶段一所有节点发送了 Ack，则协调者向所有节点发送 DoCommit）
* b. 事务提交（节点收到 DoCommit，执行提交）
* c. 反馈提交结果（反馈 Ack）
* d. 完成事务（协调周收到所有 Ack 后完成事务）

注意：一旦进入本阶段，会存在协调者出问题或网络故障。

### 优缺点

优点：降低节点阻塞范围，单点故障后可继续达成一致。

缺点：阶段二节点收到 PreCommit 后，如果网络故障，节点仍然会提交事务，造成数据不一致。

---

# 二. Paxos 算法

Paxos 算法是公认的解决分布式一致性问题最有效的算法之一。

Paxos 算法需要解决的问题是：在一个可能发生宕机、网络异常的分布式系统中，快速正确地在集群内对某个数据值达成一致，且不会破坏整个系统的一致性。

Paxos 算法的目标：保证最终由一个提案会被选定，当提案被选定后，进程最终也可以获取到该提案。

## 算法理解参考

* [维基百科](https://zh.wikipedia.org/wiki/Paxos算法)
* [cnblogs](https://www.cnblogs.com/endsock/p/3480093.html)

